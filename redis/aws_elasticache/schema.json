{
  "title": "AWS ElastiCache for Redis Flavour Configuration",
  "type": "object",
  "allOf": [
    {
      "if": {
        "properties": {
          "automaticFailoverEnabled": { "const": true }
        }
      },
      "then": {
        "properties": {
          "replicasPerNodeGroup": { "minimum": 1 }
        },
        "errorMessage": "automaticFailoverEnabled requires at least 1 replica (replicasPerNodeGroup must be >= 1)"
      }
    },
    {
      "if": {
        "properties": {
          "multiAzEnabled": { "const": true }
        }
      },
      "then": {
        "properties": {
          "automaticFailoverEnabled": { "const": true }
        },
        "errorMessage": "multiAzEnabled requires automaticFailoverEnabled to be true"
      }
    },
    {
      "if": {
        "properties": {
          "snapshotRetentionLimit": { "minimum": 1 }
        }
      },
      "then": {
        "required": ["snapshotWindow"],
        "errorMessage": "snapshotWindow is required when snapshotRetentionLimit is greater than 0"
      }
    }
  ],
  "properties": {
    "replicationGroupId": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9\\-]{0,39}$",
      "description": "Unique identifier for the replication group. Must be 1-40 alphanumeric characters or hyphens, begin with a letter, and contain no spaces or uppercase letters. This becomes the AWS resource name. **Required by AWS API**."
    },
    "replicationGroupDescription": {
      "type": "string",
      "maxLength": 255,
      "description": "Human-readable description of the replication group. Used for AWS resource management and documentation. **Default: `'ElastiCache Redis replication group'`**.",
      "default": "ElastiCache Redis replication group"
    },
    "cacheNodeType": {
      "type": "string",
      "pattern": "^cache\\.[a-z0-9]+\\.(micro|small|medium|large|xlarge|[0-9]+xlarge)$",
      "description": "The AWS instance type for the Redis nodes (e.g., `cache.t3.micro`). This is the primary driver of performance and cost, and must be chosen carefully based on your workload and budget. **Default: `cache.t4g.micro`** (smallest ARM-based general-purpose instance for cost efficiency).",
      "default": "cache.t4g.micro"
    },
    "numNodeGroups": {
      "type": "number",
      "minimum": 1,
      "maximum": 500,
      "description": "The number of shards for a Redis Cluster. Only applicable if `clusterModeEnabled` is true. Valid range: 1-500. **Default: `1`** (single shard).",
      "default": 1
    },
    "replicasPerNodeGroup": {
      "type": "number",
      "minimum": 0,
      "maximum": 5,
      "description": "The number of read replicas per shard. Replicas enable high availability and read scaling but increase costs. Valid range: 0-5. Set to 1 or more for production workloads. **Default: `0`** (no replicas, minimizing cost for development/testing).",
      "default": 0
    },
    "cacheSubnetGroupName": {
      "type": "string",
      "description": "The name of the ElastiCache Subnet Group, which defines the VPC and subnets for the cluster. This is fundamental for placing Redis within your private network."
    },
    "securityGroupIds": {
      "type": "array",
      "description": "A list of VPC Security Group IDs that act as a virtual firewall for the cluster. This is a critical security setting that controls network access to your Redis nodes.",
      "items": {
        "type": "string",
        "pattern": "^sg-[a-f0-9]+$"
      },
      "minItems": 1
    },
    "parameterGroupName": {
      "type": "string",
      "description": "The name of the AWS ElastiCache Parameter Group to apply. If not specified, the AWS default parameter group for the selected `redisVersion` will be used."
    },
    "automaticFailoverEnabled": {
      "type": "boolean",
      "description": "If `true`, ElastiCache automatically promotes a replica if the primary fails. Requires at least one replica. Enable for production workloads. **Default: `false`** (disabled to minimize complexity and cost for development/testing).",
      "default": false
    },
    "multiAzEnabled": {
      "type": "boolean",
      "description": "If `true`, spreads replicas across multiple Availability Zones for resilience against AZ failures. Enable for production workloads. **Default: `false`** (single AZ to minimize cost for development/testing).",
      "default": false
    },
    "transitEncryptionEnabled": {
      "type": "boolean",
      "description": "Enables TLS to encrypt data in transit between clients and the Redis server. Enable for production workloads handling sensitive data. Note: may impact performance. **Default: `false`** (disabled to simplify client configuration for development/testing).",
      "default": false
    },
    "atRestEncryptionEnabled": {
      "type": "boolean",
      "description": "Enables encryption of data stored on disk (backups and swap files). Enable for production workloads with compliance requirements. **Default: `false`** (disabled to minimize cost and complexity for development/testing).",
      "default": false
    },
    "snapshotRetentionLimit": {
      "type": "number",
      "minimum": 0,
      "maximum": 35,
      "description": "The number of days to retain automatic backups. Backups incur storage costs. Valid range: 0-35 days. Set to 7-30 for production workloads. **Default: `0`** (no backups, minimizing storage costs for development/testing).",
      "default": 0
    },
    "preferredMaintenanceWindow": {
      "type": "string",
      "pattern": "^(mon|tue|wed|thu|fri|sat|sun):[0-9]{2}:[0-9]{2}-(mon|tue|wed|thu|fri|sat|sun):[0-9]{2}:[0-9]{2}$",
      "description": "The weekly time range (in UTC) for system maintenance. Format: `ddd:hh:mm-ddd:hh:mm` (e.g., `sun:04:00-sun:05:00`). Minimum window is 60 minutes. If not specified, AWS will assign one."
    },
    "tags": {
      "type": "object",
      "description": "A key-value map of AWS tags to apply to all created resources for cost tracking, automation, and organization. **Default: `{}`** (no tags).",
      "default": {}
    },
    "timeout": {
      "type": "number",
      "description": "The client idle timeout in seconds. Set a non-zero value to automatically close idle clients. **Default: `0`** (disabled, suitable for long-lived connections).",
      "default": 0
    },
    "snapshotWindow": {
      "type": "string",
      "pattern": "^[0-9]{2}:[0-9]{2}-[0-9]{2}:[0-9]{2}$",
      "description": "Daily UTC time range for automated backups. Format: `HH:MM-HH:MM` (e.g., `03:00-05:00`). Minimum 60-minute window. Required when `snapshotRetentionLimit > 0`. If not specified and snapshots are enabled, AWS assigns a window. **Production:** Set during low-traffic hours."
    },
    "notificationTopicArn": {
      "type": "string",
      "pattern": "^arn:aws:sns:[a-z0-9\\-]+:[0-9]+:[a-zA-Z0-9\\-_]+$",
      "description": "SNS topic ARN for ElastiCache events (failovers, node replacements, scaling, maintenance). **Production:** Essential for operational visibility. Create dedicated SNS topics per environment and integrate with your alerting system."
    },
    "autoMinorVersionUpgrade": {
      "type": "boolean",
      "description": "Automatically apply minor Redis version upgrades during maintenance windows for security patches and bug fixes. **Default: `true`** (recommended for security). Set `false` only with strict version control requirements.",
      "default": true
    },
    "logDeliveryConfigurations": {
      "type": "array",
      "description": "Log shipping configuration for slow-log and engine-log. Each object must specify `logType` (slow-log or engine-log), `destinationType` (cloudwatch-logs or kinesis-firehose), and `destinationDetails`. **Production:** Enable slow-log to CloudWatch for performance debugging.",
      "items": {
        "type": "object",
        "properties": {
          "logType": {
            "type": "string",
            "enum": ["slow-log", "engine-log"],
            "description": "Type of Redis log to capture"
          },
          "destinationType": {
            "type": "string",
            "enum": ["cloudwatch-logs", "kinesis-firehose"],
            "description": "AWS service to send logs to"
          },
          "destinationDetails": {
            "type": "object",
            "description": "Destination-specific configuration (log group for CloudWatch, stream for Kinesis)"
          },
          "enabled": {
            "type": "boolean",
            "description": "Whether this log configuration is enabled"
          }
        },
        "required": ["logType", "destinationType", "destinationDetails"]
      },
      "default": []
    },
    "preferredCacheClusterAZs": {
      "type": "array",
      "description": "List of EC2 Availability Zones for placing cache nodes. Number of AZs should match total node count for even distribution. **Production:** Specify AZs close to application servers to minimize latency.",
      "items": {
        "type": "string",
        "pattern": "^[a-z]{2}-[a-z]+-[0-9][a-z]$"
      }
    },
    "kmsKeyId": {
      "type": "string",
      "description": "ARN of customer-managed KMS key for at-rest encryption. Only applies when `atRestEncryptionEnabled: true`. **Production:** Use customer-managed keys for compliance (HIPAA, PCI-DSS). Ensure proper key rotation policies."
    },
    "ipDiscovery": {
      "type": "string",
      "enum": ["ipv4", "ipv6"],
      "description": "IP version for cluster discovery. Requires Redis 6.2+. **Default: `'ipv4'`**. Use `'ipv6'` only if your infrastructure requires it and clients support it.",
      "default": "ipv4"
    },
    "userGroupIds": {
      "type": "array",
      "description": "List of user group IDs for RBAC (Redis 6.0+). Each group defines users and their permissions. Only works when authentication is enabled. **Production:** Create groups like 'readonly', 'admin', 'app-specific' with appropriate ACL rules.",
      "items": {
        "type": "string"
      },
      "default": []
    }
  },
  "required": [
    "replicationGroupId",
    "cacheSubnetGroupName",
    "securityGroupIds"
  ]
}
